name: Release WSL Image

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - 'images/**'
      - '**.md'
      - '.github/workflows/stats.yml'
  pull_request:
    branches:
      - '**'
    paths-ignore:
      - 'docs/**'
      - 'images/**'
      - '**.md'
      - '.github/workflows/stats.yml'

permissions:
  contents: write # for checkout
  pull-requests: write
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-app-cdc-coe-botfrey
    steps:
      ## The default Github token does not provide a way for semantic release
      ## to publish to a protected branch without having an administrative bot
      ## account with bypass options within the repository's settings.
      ## https://github.com/orgs/community/discussions/25305
      - name: Get Github App token
        id: generate_token
        run: |
          echo "${{ secrets.PRIVATE_KEY }}" > private.pem
          result=$(npx github-app-installation-token \
            --appId ${{ vars.APP_ID }} \
            --installationId ${{ vars.INSTALLATION_ID }} \
            --privateKeyLocation private.pem)
          echo "TOKEN=$result" >> "$GITHUB_OUTPUT"

      - name: Checkout the codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: npm
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm clean-install

      - name: Verify the integrity of provenance attestations and registry signatures for installed dependencies
        run: npm audit signatures

      - name: Set up Podman
        run: |
          # Install Podman (if not already installed)
          if ! command -v podman &> /dev/null; then
            sudo apt update
            sudo apt install -y podman
          fi
          # Display Podman version
          podman --version
        shell: bash

      - name: Generate tars
        run: |
          bash build.sh

      - name: Generate checksum
        env:
          IMAGE_NAME: 'ubuntu-24.04-cdc.tar'
        run: |
          sha256sum "$IMAGE_NAME" > checksums.txt
        working-directory: ./images

      - name: 🔬 Check semantic versioning
        id: semantic-release
        env:
          GITHUB_REF: ${{ github.head_ref }}
        run: |
          npx semantic-release --no-ci --dry-run --plugins @semantic-release/commit-analyzer,@semantic-release/release-notes-generator --branches ${{ env.GITHUB_REF }} > output.txt
          OUTPUT=$(cat output.txt | base64 -w 0)
          echo "releaseNote=$OUTPUT" >> "$GITHUB_OUTPUT"

      # Updated version of this follow discussion:
      # https://github.com/semantic-release/semantic-release/discussions/1886#discussioncomment-8185820
      - name: 📝 Report semantic versioning
        uses: actions/github-script@v7
        if: ${{ steps.semantic-release.outputs.releaseNote != '' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // build release note
            const semanticReleaseOutput = Buffer.from('${{ steps.semantic-release.outputs.releaseNote }}', 'base64').toString('utf8');
            const semanticReleaseLogMatch = /^[[0-9:\sAMPM]+\]\s\[semantic-release\].*$/;
            const lines = semanticReleaseOutput.split('\n');
            const lastSemanticReleaseLogIndex = [...lines]
              .reverse()
              .findIndex((line) => line.match(semanticReleaseLogMatch));

            const releaseNoteIndex = lines.length - lastSemanticReleaseLogIndex;
            const releaseNote = lines.slice(releaseNoteIndex);

            let res = releaseNote.join('\n');
            if (!releaseNote.length || !res) {
              res = '### No release note would be generated.';
            }

            const SEMANTIC_RELEASE_BODY_HEADER = '## 📝 Semantic Release Report';
            const body = [SEMANTIC_RELEASE_BODY_HEADER, res].join('\n');

            // get last comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // find comments to delete
            const commentsToDelete = comments.data.filter((comment) =>
              comment.body.startsWith(SEMANTIC_RELEASE_BODY_HEADER)
            );

            // delete comments
            const prms = commentsToDelete.map((comment) =>
              github.rest.issues.deleteComment({
                comment_id: comment.id,
                owner: context.repo.owner,
                repo: context.repo.repo
              })
            );

            await Promise.all(prms);

            // create new comment for release note
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Release
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: '${{ steps.generate_token.outputs.TOKEN }}'
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.TOKEN }}'
        run: |
          npx semantic-release
